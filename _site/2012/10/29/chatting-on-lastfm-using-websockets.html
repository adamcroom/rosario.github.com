<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>Rosario's Blog</title>
	<meta name="description" content="Blog of a software developer living and working in europe">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="/stylesheets/pure-min.css">
	<link rel="stylesheet" href="/stylesheets/main.css">
	<link rel="stylesheet" href="/stylesheets/docco.css">
	<link rel="stylesheet" href="/stylesheets/styles/googlecode.min.css">
	<!-- [if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif] -->

	<link rel="shortcut icon" href="/images/favicon.ico">
	<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="/javascripts/highlight.pack.js"></script>


</head>
<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <header class="header">
                <hgroup>
                    <a href="/">
                        <img class="profile" src="/images/profile.jpg">
                    </a>
                    <h1 class="brand-title">Rosario Rascuna</h1>
                    <h2 class="brand-tagline">
                        Maintaner of <a href="http://roundabout.io" rel="London Startups Map">Roundabout.io</a><br>
                        Developer at <a href="http://codersumo.com" rel="Coders community">Codersumo</a><br>
                        Teacher at <a href="http://coderwave.com" rel="Web development workshops in London">Coderwave</a><br>
                        Twitter <a href="https://twitter.com/_sarhus">@_sarhus</a> <br>
                        Github <a href="http://github.com/rosario">github.com/rosario</a> <br>
                        <a href="/about.html">About me</a> <br>
                        
                    </h2>
                </hgroup>
            </header>
            <footer class="footer">
                    <div class="home-link">
                        <a rel="home" href="/"> <img src="/images/home-icon.png"/> </a>
                    </div>
            </footer>
            
            
        </div>
        <div class="pure-u-1">
            <div class="content">
                <header class="post-header">
    <h1 class="post-title"><a href="">Chatting on Last.fm using websockets</a></h1>
    <p class="post-meta">
        29 Oct 2012
        
    </p>
</header>



<h3>Adding a Chat box on Last.fm is easier than you think. Here's a quick hack.</h3>

<p><img src="/images/qop-lastfm.png" title="qop chat screenshot" alt="qop chat" /></p>

<h2>The hack</h2>

<p>As shown before, it's relatively easy to embed a <a href="/2012/05/19/chatting-on-twitter-with-pusher.html">chat box on twitter</a>.
Doing the same for <a href="http://last.fm">last.fm</a> is trivial. First, we need to add <em>omniauth_lastfm</em> in the <em>Gemfile</em> of our Sinatra app.</p>

<pre><code>gem 'omniauth-lastfm'
</code></pre>

<p>We need to add also the <em>require</em> in the app file:</p>

<pre><code>require 'omniauth-lastfm'
</code></pre>

<p>Now we have to define the OAuth callback for Lastfm:</p>

<pre><code>get '/auth/lastfm/callback' do
  auth = request.env["omniauth.auth"]

  user = User.first_or_create({ :uid =&gt; auth["uid"]}, {
    :uid =&gt; auth["uid"],
    :name =&gt; auth["info"]["name"],
    :nickname =&gt; auth["info"]["name"],
    :created_at =&gt; Time.now })

  session[:user_id] = user.id # User logged in
  redirect 'http://last.fm'
end
</code></pre>

<h2>Chrome Extension</h2>

<p>We add a <strong>Chrome Extension</strong> that automatically loads up the javascript and opens the chat box. The <em>manifest.json</em> is:</p>

<pre><code>{
   "content_scripts": [ {
      "js": [ "qop.js" ],
      "matches": [ "http://*.last.fm/*", "https://*.last.fm/*" ],
      "run_at": "document_end"
   } ],
   "description": "Last.fm Chat",
   "name": "qop.im",
   "version": "1.0",
   "manifest_version": 2
}
</code></pre>

<p>And the <strong>qop.js</strong> is:</p>

<pre><code>if (window.top === window) {
    (function(){
        link = document.createElement('link');
        link.href = 'http://YOURSERVER/application.css';
        link.type = 'text/css';
        link.rel = 'stylesheet';
        document.getElementsByTagName('head')[0].appendChild(link);
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.async = true;
        script.src = 'http://YOURSERVER/application.js';
        document.getElementsByTagName('head')[0].appendChild(script);})();
}
</code></pre>

<p>That's all. Give it a spin if you'd like, but remember that it's <em>alpha</em> code.
Here's the Chrome extension: <a href="https://chrome.google.com/webstore/detail/qopim/afbllpelodekoheogfidhgncbfpendlj">Chat on Last.fm</a></p>



<h2>Archive</h2>

<div id="post_links">
	<ul>
		
			<li><span>29 Oct 2012</span>  <a href="/2012/10/29/chatting-on-lastfm-using-websockets.html">Chatting on Last.fm using websockets</a></li>
		
			<li><span>02 Jul 2012</span>  <a href="/2012/07/02/lettera-aperta-studenti-siciliani.html">Lettera aperta agli studenti siciliani</a></li>
		
			<li><span>05 Jun 2012</span>  <a href="/2012/06/05/call-forwarding-with-twilio-and-sinatra.html">Call Forwarding with Twilio and Sinatra</a></li>
		
			<li><span>04 Jun 2012</span>  <a href="/2012/06/04/html5-video-streaming-over-websockets-using-pusher.html">HTML5 Video Streaming over WebSockets using Pusher</a></li>
		
			<li><span>02 Jun 2012</span>  <a href="/2012/06/02/responsive-images.html">Responsive images</a></li>
		
			<li><span>31 May 2012</span>  <a href="/2012/05/31/chatting-on-twitter-with-pusher-part2.html">Chatting on Twitter (2/2)</a></li>
		
			<li><span>19 May 2012</span>  <a href="/2012/05/19/chatting-on-twitter-with-pusher.html">Chatting on Twitter (1/2)</a></li>
			
	</ul>
</div>


	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'rosario'; 
		var disqus_developer = 0; // developer mode is on
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </div>
        
    </div>
    
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-31897052-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>