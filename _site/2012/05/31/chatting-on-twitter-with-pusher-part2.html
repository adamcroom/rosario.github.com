<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>Blog of Saro</title>
	<meta name="description" content="Blog of a software developer living and working in europe">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="/stylesheets/skeleton/base.css">
	<link rel="stylesheet" href="/stylesheets/skeleton/skeleton.css">
	<link rel="stylesheet" href="/stylesheets/skeleton/layout.css">
	<link rel="stylesheet" href="/stylesheets/main.css">
	<link rel="stylesheet" href="/stylesheets/docco.css">
	<link rel="stylesheet" href="/stylesheets/styles/googlecode.min.css">
	<!-- [if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif] -->

	<link rel="shortcut icon" href="/images/favicon.ico">
	<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="/javascripts/highlight.pack.js"></script>


</head>
<body>
	<div class="container">
		<div class="four columns sidebar">
			<nav>
				<h4 id="logo">Blog of Saro</h4>
				<ul>
 					<li><a href="/">Home</a></li>
					<!-- li><a href="/archive">Archive</a></li> -->
					<h5> Rosario works and lives in London, he likes Brighton and loves Budapest. </h5>
					<h5 class="followme">You can follow me here:
						<a href="https://twitter.com/_sarhus">@_sarhus</a>
						<img src="/images/followme.png"/>
					</h5>
				</ul>
			</nav>

			&nbsp;
		</div>
		<div class="twelve columns content">
			<h1 class="title">Chatting on Twitter (2/2)</h1>
<p class="date"> 31 May 2012 </p>

<h3>How to setup Sprockets without Rails. Self referencial association with DataMapper. Delayed job for Sinatra.</h3>

<h2>Overview</h2>

<p>In the <a href="/2012/05/19/Chatting-on-twitter-with-pusher.html" title="previous post">previous post</a>, we have seen how to embed a chat widget with Coffescript.
We mainly covered javascript events sent from the server to the clients using
<a href="http://www.pusher.com" title="pusher">pusher</a>. In this post we will see how to setup
Sprockets without Rails,  we'll cover self referential associations for friendship
relations, and finally we'll setup Delayed Job with Sinatra to fetch user's friends
in background.</p>

<p>Source code can be found here: <a href="https://github.com/rosario/qop" title="qop source">qop source</a></p>

<h2>Sprockets without Rails</h2>

<p>Sprockets is a utility to compile coffescript/javascript and stylesheets. It's very useful when we write
lots of javascript and we need a way to package all the files in a single <em>application.js</em>. It also
supports <em>ECO</em> templates and automatically creates a global variable to store our javascript templates.</p>

<p>Blatantly taken from <a href="http://www.simonecarletti.com/blog/2011/09/using-sprockets-without-a-railsrack-project/" title="sprockets without rails">sprockets without rails</a>
courtesy of <a href="http://www.simonecarletti.com/" title="Simone Carletti">Simone Carletti</a>, there is an effective
way to setup Sprockets without Rails. The following code goes in a <strong>Rakefile.rb</strong>.</p>

<pre><code>  require 'rubygems'
  require 'bundler'
  require 'pathname'
  require 'logger'
  require 'fileutils'
  require 'data_mapper'

  Bundler.require

  ROOT        = Pathname(File.dirname(__FILE__))
  LOGGER      = Logger.new(STDOUT)
  BUNDLES     = %w( application.css application.js )
  BUILD_DIR   = ROOT.join("public")
  SOURCE_DIR  = ROOT.join("assets")



  task :compile do
    sprockets = Sprockets::Environment.new(ROOT) do |env|
      env.logger = LOGGER
    end

    sprockets.append_path(SOURCE_DIR.join('javascripts').to_s)
    sprockets.append_path(SOURCE_DIR.join('templates').to_s)
    sprockets.append_path(SOURCE_DIR.join('stylesheets').to_s)

    BUNDLES.each do |bundle|
      assets = sprockets.find_asset(bundle)
      prefix, basename = assets.pathname.to_s.split('/')[-2..-1]
      FileUtils.mkpath BUILD_DIR.join(prefix)

      assets.to_a.each do |asset|
        # strip filename.css.foo.bar.css multiple extensions
        realname = asset.pathname.basename.to_s.split(".")[0..1].join(".")
        asset.write_to(BUILD_DIR.join(prefix, realname))
      end

      assets.write_to(BUILD_DIR.join(prefix, basename))
    end
  end
</code></pre>

<p>It is also useful to automatically save and compile javascript files without manually running rake tasks.
To do so, we setup a <strong>watchr</strong> file, and install the gem <a href="https://github.com/mynyml/watchr" title="watchr">watchr</a>.</p>

<pre><code>  def run_sprockets
    print "\nCompiling... "
    system('rake compile')
    print "done.\n"
  end

  Signal.trap('INT') { abort("\n") }
  watch( 'assets/javascripts/*') { run_sprockets}
  watch( 'assets/templates/*') { run_sprockets}
</code></pre>

<h2>Relationship status: It's not complicated</h2>

<p>We use <a href="http://datamapper.org/" title="Datamapper">Datamapper</a> for out database models. It's easy to use and
we don't have to worry about migrations (and that's ok given this simplicity of this project). Documentation
is really good, we reuse part of <em>Self referential many to many relationships</em> section in
<a href="http://datamapper.org/docs/associations.html" title="Associations">Associations</a>
and we add few utility methods.</p>

<pre><code>  class User
    include DataMapper::Resource

    property :id,         Serial
    property :name,       String
    property :uid,        String, :required =&gt; true
    property :nickname,   String
    property :created_at, DateTime
    property :online,     Boolean, :default  =&gt; false

    has n, :friendships, :child_key =&gt; [ :source_id ]
    has n, :friends, self, :through =&gt; :friendships, :via =&gt; :target

    has n, :inverse_friendships, 'Friendship', :child_key =&gt;[:target_id]
    has n, :inverse_friends, self, :through =&gt;:inverse_friendships, :via =&gt;:source
    def online!
      self.online = true
      self.save
    end

    def friend?(friend)
      friends.first(:id =&gt;friend.id) or inverse_friends.first(:id=&gt;friend.id)
    end

    def offline!
      self.online = false
      self.save
    end

    def online_friends
      fs = friends.all(:online=&gt;true)
      ls = inverse_friends.all(:online=&gt;true)
      fs + ls
    end

  end

  class Friendship
    include DataMapper::Resource
    belongs_to :source, 'User', :key =&gt; true
    belongs_to :target, 'User', :key =&gt; true
  end
</code></pre>

<p>We have added <strong>online</strong> and <strong>offline</strong> methods, a method to get online friends and
the <em>inverse_friendship</em> relation. If user <em>A</em> is friend with user <em>B</em>, then it means <em>B</em> is also
friend with <em>A</em>. We store this relation only once in the <strong>Friendship</strong> table and use the inverse
friendship relation.</p>

<h2>Omniauth Twitter strategy using Sinatra</h2>

<p><a href="https://github.com/intridea/omniauth" title="Omniauth">Omniauth</a> makes it very easy to authenticate with Twitter.
We just need to provide a callback method, and store the user informations.</p>

<pre><code>  get '/auth/twitter/callback' do

    auth = request.env["omniauth.auth"]
    user = User.first_or_create({ :uid =&gt; auth["uid"]}, {
      :uid =&gt; auth["uid"],
      :nickname =&gt; auth["info"]["nickname"],
      :name =&gt; auth["info"]["name"],
      :created_at =&gt; Time.now 
    })

    if user.nickname.nil? or user.nickname.empty?
      user.nickname = auth["info"]["nickname"]
      user.save
    end

    if user and user.nickname and user.friends.empty?
      job = LookupFriends.new(user.nickname)
      Delayed::Job.enqueue job
    end
    session[:user_id] = user.id
    redirect 'https://twitter.com'
  end
</code></pre>

<h2>Sinatra and Delayed Job</h2>

<p>In the previous code snippet we use <em>Delayed Job</em> to fetch our friends. We need to setup
<a href="https://github.com/collectiveidea/delayed_job" title="delayed job">delayed job</a>
with Sinatra and define a couple of <em>tasks</em> to start and clear the job queue in our <em>Rakefile.rb</em>.
Note that the following  tasks are useful when we deploy the code to <a href="http://www.heroku.com" title="heroku">heroku</a>.</p>

<pre><code>  task :environment do
    require 'delayed_job'
    require 'delayed_job_data_mapper'
    require './models'
    require './job'
    DataMapper.setup(:default, ENV['DATABASE_URL'] || "sqlite3://#{Dir.pwd}/db.sqlite3")
    DataMapper.finalize
  end


  namespace :jobs do
    desc "Clear the delayed_job queue."
    task :clear =&gt; :environment do
      Delayed::Job.delete_all
    end

    desc "Start a delayed_job worker."
    task :work =&gt; :environment do
      Delayed::Worker.new(
        :min_priority =&gt; ENV['MIN_PRIORITY'], 
        :max_priority =&gt; ENV['MAX_PRIORITY']).start
    end
  end
</code></pre>

<p>Delayed Job is now ready. We need to setup the actual <em>worker</em>:</p>

<pre><code>  class LookupFriends &lt; Struct.new(:nickname)

    def perform
      friends = Twitter.friend_ids(nickname.to_s)
      user = User.first(:nickname =&gt; nickname)
      if friends.ids
        friends.ids.each do |id|
          friend = User.first_or_create(:uid=&gt; id)
          user.friends &lt;&lt; friend unless user.friends.first(:uid=&gt; id)
        end
        user.save
      end
    end
  end
</code></pre>

<h2>Conclusions</h2>

<p>In the previous post we've seen how to embed a chat widget inside a Twitter page,
using pusher and CORS requests.</p>

<p>Behind the scenes though there are few tricks to talk about. The widgets is a coffescript <em>single page</em>
mini application. Sprockets is an important tool to glue Coffescript files together. The database used
is  necessary to check for online or offline users. Finally, we've seen how to setup Delayed Job to
fetch data in background, and populate the database with <em>friends</em> data.</p>



<h2>Archive</h2>

<div id="post_links">
	<ul>
		
			<li><span>02 Jul 2012</span>  <a href="/2012/07/02/lettera-aperta-studenti-siciliani.html">Lettera aperta agli studenti siciliani</a></li>
		
			<li><span>05 Jun 2012</span>  <a href="/2012/06/05/call-forwarding-with-twilio-and-sinatra.html">Call Forwarding with Twilio and Sinatra</a></li>
		
			<li><span>04 Jun 2012</span>  <a href="/2012/06/04/html5-video-streaming-over-websockets-using-pusher.html">HTML5 Video Streaming over WebSockets using Pusher</a></li>
		
			<li><span>02 Jun 2012</span>  <a href="/2012/06/02/responsive-images.html">Responsive images</a></li>
		
			<li><span>31 May 2012</span>  <a href="/2012/05/31/chatting-on-twitter-with-pusher-part2.html">Chatting on Twitter (2/2)</a></li>
		
			<li><span>19 May 2012</span>  <a href="/2012/05/19/chatting-on-twitter-with-pusher.html">Chatting on Twitter (1/2)</a></li>
			
	</ul>
</div>


	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'rosario'; 
		var disqus_developer = 0; // developer mode is on
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

		</div>
		
		<!-- <div class="sixteen columns footer"></div> -->
	</div>
	<script>hljs.initHighlightingOnLoad();</script>
	
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-31897052-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>	
</body>
</html>