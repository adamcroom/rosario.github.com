<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>Blog of Saro</title>
	<meta name="description" content="Blog of a software developer living and working in europe">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="/stylesheets/skeleton/base.css">
	<link rel="stylesheet" href="/stylesheets/skeleton/skeleton.css">
	<link rel="stylesheet" href="/stylesheets/skeleton/layout.css">
	<link rel="stylesheet" href="/stylesheets/main.css">
	<link rel="stylesheet" href="/stylesheets/docco.css">
	<!-- [if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif] -->

	<link rel="shortcut icon" href="/images/favicon.ico">
	<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">	
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>


</head>
<body>
	<div class="container">
		<div class="four columns sidebar">
			<nav>
				<h4 id="logo">Blog of Saro</h4>
				<ul>
 					<li><a href="/">Home</a></li>
					<!-- li><a href="/archive">Archive</a></li> -->
					<h5> Rosario works and lives in London, he likes Brighton and loves Budapest. </h5>
					<h5 class="followme">You can follow me here:
						<a href="https://twitter.com/_sarhus">@_sarhus</a>
						<img src="/images/followme.png"/>
					</h5>
				</ul>
			</nav>

			&nbsp;
		</div>
		<div class="twelve columns content">
			<h1 class="title">Chatting on Twitter (2/2)</h1>
<p class="date"> 31 May 2012 </p>

<h3 id='can_we_embed_a_chat_widget_on_twitter_yes_with_few_tricks_and_pusher_we_can_create_a_widget_and_chat_with_our_twitter_friends'>Can we embed a chat widget on <strong>Twitter</strong>? Yes, with few tricks and <strong>Pusher</strong> we can create a widget and chat with our Twitter friends.</h3>

<p><img alt='qop chat' src='/images/screenshot.png' /></p>

<h2 id='overview'>Overview</h2>

<p>This is a short description of <strong>qop</strong>, a simple and unpretentious chat widget written in Ruby and Coffeescript. It uses <a href='http://pusher.com/' title='Pusher'>Pusher</a> to send chat messages to our <a href='http://twitter.com/' title='Twitter'>Twitter</a> friends, and it can be embedded on a Twitter page.</p>

<p>The technical part: Web services are provided with Sinatra. Authentication is done via Omniauth. Data models are written in Datamapper, and Handlebars is used for templates.</p>

<p>Finally a custom Sprockets process will glue everything together. As easy as that!</p>

<p><img alt='qop chat' src='/images/qop2.png' /></p>

<h2 id='the_bookmarklet'>The bookmarklet</h2>

<p>A bookmarklet loads the widget from our server, and this is the code:</p>
<div class='highlight'><pre><code class='javascript'>    
      <span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
        <span class='nx'>link</span> <span class='o'>=</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>createElement</span><span class='p'>(</span><span class='s1'>&#39;link&#39;</span><span class='p'>);</span>
        <span class='nx'>link</span><span class='p'>.</span><span class='nx'>href</span> <span class='o'>=</span> <span class='s1'>&#39;https://YOURQOPSERVER.herokuapp.com/assets/application.css&#39;</span><span class='p'>;</span>
        <span class='nx'>link</span><span class='p'>.</span><span class='nx'>type</span> <span class='o'>=</span> <span class='s1'>&#39;text/css&#39;</span><span class='p'>;</span>
        <span class='nx'>link</span><span class='p'>.</span><span class='nx'>rel</span> <span class='o'>=</span> <span class='s1'>&#39;stylesheet&#39;</span><span class='p'>;</span>
        <span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementsByTagName</span><span class='p'>(</span><span class='s1'>&#39;head&#39;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>appendChild</span><span class='p'>(</span><span class='nx'>link</span><span class='p'>);</span>

        <span class='kd'>var</span> <span class='nx'>script</span> <span class='o'>=</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>createElement</span><span class='p'>(</span><span class='s1'>&#39;script&#39;</span><span class='p'>);</span>
        <span class='nx'>script</span><span class='p'>.</span><span class='nx'>type</span> <span class='o'>=</span> <span class='s1'>&#39;text/javascript&#39;</span><span class='p'>;</span>
        <span class='nx'>script</span><span class='p'>.</span><span class='nx'>async</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
        <span class='nx'>script</span><span class='p'>.</span><span class='nx'>src</span> <span class='o'>=</span> <span class='s1'>&#39;https://YOURQOPSERVER.herokuapp.com/assets/application.js&#39;</span><span class='p'>;</span>
        <span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementsByTagName</span><span class='p'>(</span><span class='s1'>&#39;head&#39;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>appendChild</span><span class='p'>(</span><span class='nx'>script</span><span class='p'>);</span>
      <span class='p'>})();</span>
    
</code></pre>
</div>
<p>Note that it will be easy to create a Chrome Extension, just add a <em>manifest.json</em> and Chrome will do the rest. The file <em>application.js</em> contains the entire javascript code for the widget.</p>

<h2 id='loading_please_wait'>Loading, please wait</h2>

<p>We load jQuery and wait until is ready to be used. We also need to load Pusher library, and finally load <strong>qop</strong>.</p>
<div class='highlight'><pre><code class='coffeescript'>    
     <span class='nv'>done = </span><span class='kc'>false</span>
      <span class='nv'>script = </span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>createElement</span><span class='p'>(</span><span class='s1'>&#39;script&#39;</span><span class='p'>)</span>
      <span class='nv'>script.src = </span><span class='s1'>&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js&#39;</span>
      
      <span class='nv'>script.onload = script.onreadystatechange = </span><span class='o'>-&gt;</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='nx'>done</span> <span class='o'>and</span> <span class='p'>(</span><span class='o'>!</span><span class='nx'>@readyState</span> <span class='o'>or</span> <span class='nx'>@readyState</span> <span class='o'>==</span><span class='s1'>&#39;loaded&#39;</span> <span class='o'>or</span> <span class='nx'>@readyState</span> <span class='o'>==</span><span class='s1'>&#39;complete&#39;</span><span class='p'>))</span>
          <span class='nv'>done = </span><span class='kc'>true</span>
          
          <span class='nb'>window</span><span class='p'>.</span><span class='nx'>qop</span><span class='nv'>$ = </span><span class='nx'>jQuery</span><span class='p'>.</span><span class='nx'>noConflict</span><span class='p'>();</span>
          <span class='nb'>window</span><span class='p'>.</span><span class='nx'>qop</span><span class='nv'>$.support.cors = </span><span class='kc'>true</span>
          
          <span class='nx'>qop$</span><span class='p'>.</span><span class='nx'>getScript</span><span class='p'>(</span><span class='s2'>&quot;https://d3dy5gmtp8yhk7.cloudfront.net/1.11/pusher.min.js&quot;</span><span class='p'>)</span>
            <span class='p'>.</span><span class='nx'>done</span> <span class='nf'>(script) -&gt;</span>
              <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span> <span class='s1'>&#39;loading app...&#39;</span>
              <span class='nv'>app = </span><span class='k'>new</span> <span class='nx'>QoP</span><span class='p'>.</span><span class='nx'>App</span><span class='p'>()</span>
            <span class='p'>.</span><span class='nx'>fail</span> <span class='nf'>(jqxhr, settings, exception) -&gt;</span>
              <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span> <span class='s1'>&#39;failed&#39;</span>
              
      <span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementsByTagName</span><span class='p'>(</span><span class='s1'>&#39;head&#39;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>appendChild</span><span class='p'>(</span><span class='nx'>script</span><span class='p'>)</span>
    
</code></pre>
</div>
<p>The <strong>App</strong> class doesn&#8217;t do much, just initialise Pusher with the right credentials, and creates the contact list.</p>
<div class='highlight'><pre><code class='coffeescript'>    <span class='k'>class</span> <span class='nx'>QoP</span><span class='p'>.</span><span class='nx'>App</span>
      <span class='nv'>constructor: </span><span class='o'>-&gt;</span>
        <span class='nx'>qop$</span><span class='p'>(</span><span class='s2'>&quot;&lt;div id=&#39;qop&#39;&gt;&lt;/div&gt;&quot;</span><span class='p'>).</span><span class='nx'>appendTo</span> <span class='s1'>&#39;body&#39;</span>
        <span class='nv'>Pusher.channel_auth_endpoint = </span><span class='s1'>&#39;https://YOURQOPSERVER.herokuapp.com/pusher/auth&#39;</span>
        <span class='nv'>Pusher.channel_auth_transport = </span><span class='s1'>&#39;jsonp&#39;</span>
        <span class='nv'>QoP.pusher = </span><span class='k'>new</span> <span class='nx'>Pusher</span> <span class='s1'>&#39;APPKEY&#39;</span>
        <span class='nv'>contacts = </span><span class='k'>new</span> <span class='nx'>QoP</span><span class='p'>.</span><span class='nx'>Contacts</span><span class='p'>(</span><span class='s1'>&#39;contact_list&#39;</span><span class='p'>,</span> <span class='s1'>&#39;Contact List&#39;</span><span class='p'>)</span>
</code></pre>
</div>
<h2 id='youre_a_bit_too_pushy'>You&#8217;re a bit too Pushy</h2>

<p><a href='http://pusher.com/' title='Pusher'>Pusher</a> provides a great <strong>websockets</strong> service and API, and we use websockets to send chat messages to our twitter friends.</p>

<p><img alt='qop chat' src='/images/pusher.png' /></p>

<p>The browser sends <em>AJAX</em> requests to our server. Since the chat widget is loaded from <em>twitter.com</em>, we are doing cross domain requests. CORS stands for Cross-Origin Resource Sharing, and it does what it says. Modern browsers support CORS, and we only care about modern browsers. We could use JSONP, but that is really old school (and CORS is more elegant).</p>

<p>The browser makes <em>CORS</em> requests to our server using jQuery:</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>We force jQuery to use <strong>cors</strong>, by setting a flag to true, we also need to pass <em>xhrFields</em> and set <strong>withCredentials</strong> to true. It shouldn&#8217;t be needed, but just in case we also set <strong>crossDomain</strong> to true. It is a bit redundant, but there have been cases it won&#8217;t work otherwise. If you know any better way of doing this, please let me know.</p>

<p>The server needs to know we want to accept requests from <em>twitter.com</em>. Since the server is a <strong>Sinatra</strong> application we use the <strong>rack-cors</strong> gem. (You want to include localhost for testing).</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>Each url corresponds to a service we provide to the chat widget.</p>

<h2 id='my_friends_are_your_friends'>My Friends are your Friends</h2>

<p>Let&#8217;s see how to populate the contact list</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>The <strong>chat_session</strong> method returns a JSON object with user&#8217;s online <em>@friends</em>, <em>@uid</em> (unique identifier provided by Twitter) and <em>@nickname</em>. Note, <strong>online</strong> means the user has been authenticated with our server. (The <strong>JST</strong> variable is generated by Sprockets and it holds our handlebars templates).</p>

<p>The <strong>initPresenceChannel</strong> function is called (via a trigger) if <em>chat_session</em> request is succesful.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>If the user is online (authenticated) we subscribe the user to <strong>his own</strong> presence channel. If the user is not online, we will show a signup link inside the widget, asking the user to authenticate. Authentication is done via the <strong>omniauth-twitter</strong> gem.</p>

<h2 id='presence_channels_with_pusher'>Presence Channels with Pusher</h2>

<p>Each user has got a <em>personal</em> presence channel. We use this channel to communicate events to the user. For example, we use the presence channel to let a user when a friend <em>joins</em> or <em>leaves</em> the chat. Pusher makes it really easy to know about these events via <strong>webhooks</strong>. Here&#8217;s the server code:</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>When the user occupies the channel, the user status will be set to <em>online</em>, otherwise the user is <em>offline</em>. We use &#8220;cowboy&#8221; notifications to send these status changes, for each online friend we send a <em>friend_status</em> notification. Having said that, the code is highly inefficient, since we shouldn&#8217;t do that, It would be better to send notifications outside the http request cycle&#8230; Anyway&#8230;</p>

<h2 id='look_ma_i_have_a_friend'>Look Ma, I have a friend</h2>

<p>At this point the user is authenticated and his presence channel is working. It&#8217;s time to show/hide friends and to open a chat box when we click on their nickname.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>Adding an online friend is easy, we check if the friend isn&#8217;t already shown, then we fill a template with the relevant data, and we append this template to the contact list. To remove an offline friend is even easier.</p>

<p>Now we need to create a chat box. Pusher is here to help us again. We bind the click event so that when we click on the nickname the browser does an <em>AJAX</em> <strong>chat_request</strong> to our server.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>If our friend is online we create a new channel. This channel holds the chat between the two users. We use Pusher to trigger a <strong>create_chat</strong> event in the browsers.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>The <em>createChat</em> creates a new Panel, and it allows us to chat with our friend.</p>

<h2 id='panel_discussions'>Panel Discussions</h2>

<p>The Panel is where we type our messages and chat with our friend. Each Panel has a pusher channel associated with it, and this channel is used to send chat messages.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>To create the Panel, we render the template and append a text area.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>We also need to subscribe the users to the new channel.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>Twitter has keyboard shortcuts, we need to disable them when the user is typing. After the user hits <em>enter</em> we send the message to our server:</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<p>Eventually, we&#8217;ll also receive a message. Again, we render the message using handlebars template and append the message to the Panel. We also need to scroll the content all the way up to the top, so that we can read the message when it arrives.</p>

<pre><code>Liquid error: Resource temporarily unavailable - posix_spawnp</code></pre>

<h2 id='conclusions'>Conclusions</h2>

<p>There&#8217;s a lot more to say, we still have to see how to use Omniauth to authenticate the user, how to use DelayedJob to fetch friends data in background, how to setup a custom Sprockets without Rails, and the database relations and models used.</p>

<p>But that will be the subject of the next post!</p>

<p class="comments"> 
	<a href="http://news.ycombinator.com/item?id=3998828"> Comments on HN </a> 
</p>

		</div>
		
		<!-- <div class="sixteen columns footer"></div> -->
	</div>
	
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-31897052-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>	
</body>
</html>